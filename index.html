<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Safe Token Transfer</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>
  <style>
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
    }
  </style>
</head>
<body>
  <h1>Propose ERC-20 Transfer from Gnosis Safe</h1>
  <label>Safe Address: <input id="safeAddress" type="text" placeholder="0x..." size="42"></label><br>
  <label>Token Address: <input id="tokenAddress" type="text" placeholder="0x..." size="42"></label><br>
  <label>Recipient Address: <input id="destination" type="text" placeholder="0x..." size="42"></label><br>
  <label>Amount: <input id="amount" type="text" placeholder="Amount"></label><br><br>
  <button id="approveBtn">Approve Transfer</button>
  <button id="executeBtn" disabled>Execute Transfer</button>
  <button id="previewBtn">Preview Transaction</button>
  <p id="status"></p>

  <div id="modal">
    <div id="modalContent">
      <h3>Transaction Preview</h3>
      <p id="previewText"></p>
      <button onclick="document.getElementById('modal').style.display='none'">Close</button>
    </div>
  </div>

  <script>
    const SAFE_ABI = [
      "function getTransactionHash(address to, uint256 value, bytes data, uint8 operation, uint256 safeTxGas, uint256 baseGas, uint256 gasPrice, address gasToken, address refundReceiver, uint256 _nonce) public view returns (bytes32)",
      "function nonce() view returns (uint256)",
      "function execTransaction(address to, uint256 value, bytes data, uint8 operation, uint256 safeTxGas, uint256 baseGas, uint256 gasPrice, address gasToken, address refundReceiver, bytes signatures) returns (bool)"
    ];

    const ERC20_ABI = [
      "function transfer(address to, uint256 value) returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    let prepared = {};

    async function approveTransfer() {
      const status = document.getElementById("status");
      const safeAddr = document.getElementById("safeAddress").value.trim();
      const tokenAddr = document.getElementById("tokenAddress").value.trim();
      const destination = document.getElementById("destination").value.trim();
      const amount = document.getElementById("amount").value.trim();

      if (!ethers.isAddress(safeAddr) || !ethers.isAddress(tokenAddr) || !ethers.isAddress(destination) || !amount) {
        status.textContent = "Invalid input. Please check all fields.";
        return;
      }

      if (!window.ethereum) {
        status.textContent = "MetaMask not detected.";
        return;
      }

      try {
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = await provider.getSigner();
        const token = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
        const decimals = await token.decimals();
        const amountRaw = ethers.parseUnits(amount, decimals);
        const transferCalldata = token.interface.encodeFunctionData("transfer", [destination, amountRaw]);

        const safe = new ethers.Contract(safeAddr, SAFE_ABI, signer);
        const nonce = await safe.nonce();

        // Estimate safeTxGas using callStatic
        const gasEstimate = await safe.connect(signer).estimateGas.execTransaction(
          tokenAddr, 0, transferCalldata, 0,
          0, 0, 0, ethers.ZeroAddress, ethers.ZeroAddress, "0x"
        );

        const safeTxGas = gasEstimate;
        const baseGas = 0;
        const gasPrice = 0;

        const txHash = await safe.getTransactionHash(
          tokenAddr, 0, transferCalldata, 0,
          safeTxGas, baseGas, gasPrice,
          ethers.ZeroAddress, ethers.ZeroAddress,
          nonce
        );

        const flatSig = await signer.signMessage(ethers.getBytes(txHash));
        const sig = flatSig + "01".replace("0x", "");

        prepared = {
          safe, tokenAddr, transferCalldata, sig,
          destination, amount, decimals,
          safeTxGas, baseGas, gasPrice
        };
        document.getElementById("executeBtn").disabled = false;
        status.textContent = `Transaction approved. Ready to execute.`;
      } catch (err) {
        console.error(err);
        status.textContent = `Approval error: ${err.message}`;
      }
    }

    async function executeTransfer() {
      const status = document.getElementById("status");
      if (!prepared.safe) {
        status.textContent = "Transaction not approved.";
        return;
      }

      try {
        const tx = await prepared.safe.execTransaction(
          prepared.tokenAddr,
          0,
          prepared.transferCalldata,
          0,
          prepared.safeTxGas,
          prepared.baseGas,
          prepared.gasPrice,
          ethers.ZeroAddress,
          ethers.ZeroAddress,
          prepared.sig
        );
        status.textContent = `Transaction executed: ${tx.hash}`;
      } catch (err) {
        console.error(err);
        status.textContent = `Execution error: ${err.message}`;
      }
    }

    function previewTransaction() {
      const previewText = document.getElementById("previewText");
      const destination = document.getElementById("destination").value;
      const amount = document.getElementById("amount").value;
      const token = document.getElementById("tokenAddress").value;
      const safe = document.getElementById("safeAddress").value;

      previewText.textContent = `Sending ${amount} tokens from Safe ${safe} to ${destination} via token ${token}`;
      document.getElementById("modal").style.display = "flex";
    }

    document.getElementById("approveBtn").addEventListener("click", approveTransfer);
    document.getElementById("executeBtn").addEventListener("click", executeTransfer);
    document.getElementById("previewBtn").addEventListener("click", previewTransaction);
  </script>
</body>
</html>